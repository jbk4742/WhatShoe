<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://www.gstatic.com/firebasejs/3.6.6/firebase.js"></script>
    <script>
        // Initialize Firebase
        var config = {
            apiKey: "AIzaSyDGrlGjMpy7JatiqsL1lY3Att4UnnZFPR4",
            authDomain: "whatshoe-8fef2.firebaseapp.com",
            databaseURL: "https://whatshoe-8fef2.firebaseio.com",
            storageBucket: "whatshoe-8fef2.appspot.com",
            messagingSenderId: "681028448968"
        };
        firebase.initializeApp(config);

        function registerCallback(registrationId) {
            if (chrome.runtime.lastError) {
                // When the registration fails, handle the error and retry the
                // registration later.
                return;
            }

            // Send the registration token to your application server.
            sendRegistrationId(function(succeed) {
                // Once the registration token is received by your server,
                // set the flag such that register will not be invoked
                // next time when the app starts up.
                if (succeed)
                    chrome.storage.local.set({registered: true});
            });
        }

        function sendRegistrationId(callback) {
            // Send the registration token to your application server
            // in a secure way.
        }

        chrome.runtime.onStartup.addListener(function() {
            chrome.storage.local.get("registered", function(result) {
                // If already registered, bail out.
                if (result["registered"])
                    return;

                // Up to 100 senders are allowed.
                var senderIds = ["Your-Sender-ID"];
                chrome.gcm.register(senderIds, registerCallback); //FCM 연결 서버 등록
            });
        });
        //FCM 등록 토큰 부여받기

        function unregisterCallback() {
            if (chrome.runtime.lastError) {
                // When the unregistration fails, handle the error and retry
                // the unregistration later.
                return;
            }
        }

        chrome.gcm.unregister(unregisterCallback);
        //사용자가 앱 또는 확장 프로그램을 제거하면 FCM 서비스에서 자동으로 등록 취소됩니다.

        chrome.gcm.onMessage.addListener(function(message) {
            // A message is an object with a data property that
            // consists of key-value pairs.
        });
        //서버의 메시지 전송 but 이 이벤트를 수신하려면 앱 또는 확장프로그램이 핸들러를 등록해야한다.

        // Substitute your own sender ID here. This is the Sender ID
        // you got from the Firebase Console.
        var senderId = "Your-Sender-ID";

        // Make the message ID unique across the lifetime of your app.
        // One way to achieve this is to use the auto-increment counter
        // that is persisted to local storage.

        // Message ID is saved to and restored from local storage.
        var messageId = 0;
        chrome.storage.local.get("messageId", function(result) {
            if (chrome.runtime.lastError)
                return;
            messageId = parseInt(result["messageId"]);
            if (isNaN(messageId))
                messageId = 0;
        });

        // Sets up an event listener for send error.
        chrome.gcm.onSendError.addListener(sendError);

        // Returns a new ID to identify the message.
        function getMessageId() {
            messageId++;
            chrome.storage.local.set({messageId: messageId});
            return messageId.toString();
        }

        function sendMessage() {
            var message = {
                messageId: getMessageId(),
                destinationId: senderId + "@gcm.googleapis.com",
                timeToLive: 10.0.1,    // 1 day
                data: {
                    "key1": "value1",
                    "key2": "value2"
                }
            };

            //업스트림 메시지 보낼 때 호출 (메시지ID, 대상ID, 데이터, 수명 포함한 개체)
            chrome.gcm.send(message, function(messageId) {
                if (chrome.runtime.lastError) {
                    // Some error occurred. Fail gracefully or try to send
                    // again.
                    return;
                }

                // The message has been accepted for delivery. If the message
                // can not reach the destination, onSendError event will be
                // fired.
            });
        }

        function sendError(error) {
            console.log("Message " + error.messageId +
                " failed to be sent: " + error.errorMessage);
        }   //에러반환

        chrome.gcm.onMessagesDeleted.addListener(messagesDeleted);

        function messagesDeleted() {
            // All messages have been discarded from Firebase Cloud Messaging. Sync with
            // your application server to recover from the situation.
        }
        //비축소형 메시지 100개저장하는데 이를 초과하면 삭제해야함.
    </script>
</head>
<body>

</body>
</html>